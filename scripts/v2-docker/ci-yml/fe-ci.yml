name: Frontend CI/CD

on:
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  setup:
    name: Setup and Install Dependencies
    runs-on: ubuntu-latest
    outputs:
      pnpm_cache_hit: ${{ steps.cache-pnpm.outputs.cache-hit }}
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Cache pnpm modules
        id: cache-pnpm
        uses: actions/cache@v3
        with:
          path: ./node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('./pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
        working-directory: ./

  lint-and-unit-test:
    name: Lint and Unit test
    needs: setup
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
      - uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Use cached pnpm modules
        if: steps.setup.outputs.pnpm_cache_hit == 'true'
        run: echo "Using cached pnpm modules"
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Run Lint
        run: pnpm run lint
      - name: Run Unit Test
        run: pnpm run test

  integration-test:
    name: Integration Test
    needs: setup
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./
    strategy:
      fail-fast: false
      matrix:
        # í•„ìš”ì— ë”°ë¼ ì—¬ëŸ¬ ì„¤ì •ìœ¼ë¡œ í™•ì¥ (ì˜ˆ: ë‹¤ë¥¸ ë¸Œë¼ìš°ì €)
        browser: [chromium]
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 'lts/*'
      - uses: pnpm/action-setup@v2
        with:
          version: latest
      - name: Use cached pnpm modules
        if: steps.setup.outputs.pnpm_cache_hit == 'true'
        run: echo "Using cached pnpm modules"
      - name: Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
      - name: Build Next.js app for testing
        run: pnpm run build
      - name: Start Next.js app for testing
        run: pnpm run start &
      - name: Wait for App to Start (Health Check)
        run: |
            TIMEOUT=30
            sleep $TIMEOUT;
            # for i in $(seq 1 $TIMEOUT); do
            #   if curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 >/dev/null 2>&1 && [ "$status" -eq "200" ]; then
            #     echo "Application is ready"
            #     exit 0
            #   fi
            #   echo "Waiting for application... ($i/$TIMEOUT)"
            #   sleep 1
            # done
            # echo "Application did not start within the timeout"
            # exit 1
      - name: Run Playwright Tests (${{ matrix.browser }})
        run: pnpm exec playwright test --project=chromium
        env:
          PLAYWRIGHT_TEST_BASE_URL: http://localhost:3000

  # build:
  #   name: Build & Push Docker Image
  #   if: |
  #     (github.base_ref == 'develop' && needs.lint-and-unit-test.result == 'success') ||
  #     (github.base_ref == 'main' && needs.integration-test.result == 'success')
  #   needs: [lint-and-unit-test, integration-test]
  #   runs-on: ubuntu-latest

  #   steps:
  #     - name: Checkout Repository
  #       uses: actions/checkout@v3

  #     - name: Determine Docker Tag
  #       id: set-tag
  #       run: |
  #         if [[ "${{ github.ref_name }}" == "develop" ]]; then
  #           echo "tag=jchanho99/frontend-dev:latest" >> $GITHUB_OUTPUT
  #         elif [[ "${{ github.ref_name }}" == "main" ]]; then
  #           echo "tag=jchanho99/frontend-prod:latest" >> $GITHUB_OUTPUT
  #         else
  #           echo "tag=jchanho99/frontend-unknown:latest" >> $GITHUB_OUTPUT
  #         fi

  #     - name: Login to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ secrets.DOCKER_USERNAME }}
  #         password: ${{ secrets.DOCKER_TOKEN }}

  #     - name: Build and Push Docker Image
  #       uses: docker/build-push-action@v5
  #       with:
  #         context: .
  #         file: ./Dockerfile
  #         push: true
  #         tags: ${{ steps.set-tag.outputs.tag }}

  build-dev:
    name: Build and Push Docker (dev)
    needs: [lint-and-unit-test]
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: jchanho99/frontend-develop:latest

  build-prod:
    name: Build and Push Docker (prod)
    needs: [integration-test]
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Get short commit SHA
        id: get_sha
        run: echo "SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)" >> "$GITHUB_ENV"
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: jchanho99/frontend-prod:${{ env.SHORT_SHA }}
  
  deploy-dev:
    name: Deploy to Dev Server
    # if: github.event.pull_request.merged == true && github.base_ref == 'develop' # PRì´ developì— mergeë˜ì—ˆì„ ë•Œ ì‹¤í–‰
    if: github.event_name == 'pull_request' && github.base_ref == 'develop'
    needs: [build-dev]
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set-status.outputs.status }}
    steps:
      - name: Deploy to Dev
        id: deploy-step
        uses: appleboy/ssh-action@v1.0.3 # íŠ¹ì • ë²„ì „ ì‚¬ìš© ê¶Œì¥
        with:
          host: ${{ secrets.LEAFRESH_DEV_HOST }}
          username: ${{ secrets.LEAFRESH_DEV_SSH_USER }} # ê°œë°œ ì„œë²„ SSH ì‚¬ìš©ì ì´ë¦„ Secret
          key: ${{ secrets.LEAFRESH_DEV_SSH }}
          port: ${{ secrets.LEAFRESH_DEV_SSH_PORT || 22 }} # ê°œë°œ ì„œë²„ SSH í¬íŠ¸ Secret (ì—†ìœ¼ë©´ 22)
          script: |
            set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            IMAGE="jchanho99/frontend-develop:latest"
            cd /opt/frontend/
            echo "PWD: $(pwd)"
            sudo docker compose down
            sudo docker rm frontend-develop || true # frontend-develop ì»¨í…Œì´ë„ˆ ì‚­ì œ (ì˜¤ë¥˜ ë¬´ì‹œ)
            sudo docker compose up -d
            
      - name: Set Status (Dev)
        id: set-status
        if: success()
        run: echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Set Status (Dev Failure)
        if: failure() && steps.deploy-step.outcome == 'failure' # deploy-stepì´ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ
        run: echo "status=failure" >> "$GITHUB_OUTPUT"

  deploy-prod:
    name: Deploy to Prod Server (Blue-Green)
    # if: github.event.pull_request.merged == true && github.base_ref == 'main' # PRì´ mainì— mergeë˜ì—ˆì„ ë•Œ ì‹¤í–‰
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    needs: [build-prod]
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.set-status.outputs.status }}
    steps:
      - name: Deploy to Prod
        id: deploy-step
        uses: appleboy/ssh-action@v1.0.3 # íŠ¹ì • ë²„ì „ ì‚¬ìš© ê¶Œì¥
        with:
          host: ${{ secrets.LEAFRESH_PROD_HOST }}
          username: ${{ secrets.LEAFRESH_PROD_SSH_USER }} # í”„ë¡œë•ì…˜ ì„œë²„ SSH ì‚¬ìš©ì ì´ë¦„ Secret
          key: ${{ secrets.FE_SSH_PRIVATE_KEY }}
          port: ${{ secrets.LEAFRESH_PROD_SSH_PORT || 22 }} # í”„ë¡œë•ì…˜ ì„œë²„ SSH í¬íŠ¸ Secret (ì—†ìœ¼ë©´ 22)
          script: |
            set -e # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            IMAGE="jchanho99/frontend-prod:${{ env.SHORT_SHA }}"
            HEALTH_CHECK_URL="http://localhost:3001" # í—¬ìŠ¤ ì²´í¬ URL

            echo "ğŸš€ Starting Prod Blue-Green Deployment to host: ${{ secrets.LEAFRESH_PROD_HOST }}"
            echo "ğŸ–¼ï¸ Using image: $IMAGE"

            cd /opt/frontend/
            echo "PWD: $(pwd)"

            echo "ğŸšš Pulling Docker image: $IMAGE"
            sudo docker pull "$IMAGE"

            CURRENT=$(cat /opt/frontend-current 2>/dev/null || echo blue)
            NEXT=$([ "$CURRENT" = "blue" ] && echo green || echo blue)

            echo "ğŸ”µ Current active environment: $CURRENT"
            echo "ğŸŸ¢ Next environment to deploy: $NEXT"
            
            # ì°¸ê³ : ì•„ë˜ docker compose up -d ëª…ë ¹ì€ /opt/frontend/docker-compose.yml íŒŒì¼ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
            # ì´ docker-compose.yml íŒŒì¼ì´ $NEXT í™˜ê²½ (ì˜ˆ: frontend-green ì„œë¹„ìŠ¤)ì„ 
            # ì˜¬ë°”ë¥´ê²Œ ì‹œì‘í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•˜ë„ë¡ êµ¬ì„±ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
            # (ì˜ˆ: docker-compose.yml ë‚´ë¶€ì— blue, green ì„œë¹„ìŠ¤ê°€ ëª¨ë‘ ì •ì˜ë˜ì–´ ìˆê±°ë‚˜, 
            # í™˜ê²½ë³€ìˆ˜ë¥¼ í†µí•´ íƒ€ê²Ÿ ì„œë¹„ìŠ¤ì˜ ì´ë¯¸ì§€ê°€ ë™ì ìœ¼ë¡œ ì„¤ì •ë˜ëŠ” ë“±)
            echo "ğŸš€ Bringing up $NEXT environment (frontend-$NEXT)..."
            # ë§Œì•½ docker-compose.ymlì—ì„œ $NEXTì— í•´ë‹¹í•˜ëŠ” íŠ¹ì • ì„œë¹„ìŠ¤ë¥¼ ì§€ì •í•´ì•¼ í•œë‹¤ë©´,
            # ì˜ˆ: sudo docker compose up -d service-$NEXT
            # í˜„ì¬ëŠ” ì „ì²´ compose upì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            sudo docker compose up -d # ì´ ëª…ë ¹ì´ frontend-$NEXT ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘/ì—…ë°ì´íŠ¸í•´ì•¼ í•¨

            echo "ğŸ©º Performing health check for $NEXT on $HEALTH_CHECK_URL..."
            HEALTH_CHECK_PASSED=false
            for i in {1..60}; do
              # í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸ (nc ëª…ë ¹ì–´ê°€ ì„œë²„ì— ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•¨)
              if nc -z localhost 3001 2>/dev/null; then
                HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_CHECK_URL")
                if [ "$HTTP_CODE" -eq 200 ]; then
                  # ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ì˜ <title> íƒœê·¸ í™•ì¸ ë¡œì§
                  CONTENT_STATUS=$(curl -s "$HEALTH_CHECK_URL" | grep "<title>")
                  if [ ! -z "$CONTENT_STATUS" ]; then
                    echo "âœ… Health check passed for $NEXT on attempt $i (HTTP $HTTP_CODE with <title>)."
                    HEALTH_CHECK_PASSED=true
                    break
                  else
                    echo "â³ Waiting ($i)... Health check for $NEXT: HTTP $HTTP_CODE but <title> not found. Retrying..."
                  fi
                else
                  echo "â³ Waiting ($i)... Health check for $NEXT: Failed with HTTP status $HTTP_CODE. Retrying..."
                fi
              else
                echo "â³ Waiting ($i)... Health check for $NEXT: Port 3001 not listening. Retrying..."
              fi
              sleep 1
            done

            if [ "$HEALTH_CHECK_PASSED" != "true" ]; then
              echo "âŒ Health check failed for $NEXT environment after 60 attempts."
              echo "ğŸ’£ Rolling back: Attempting to stop and remove $NEXT environment (frontend-$NEXT)..."
              sudo docker stop "frontend-$NEXT" || true
              sudo docker rm "frontend-$NEXT" || true
              # í•„ìš”ì‹œ ì´ì „ $CURRENT í™˜ê²½ì„ ëª…ì‹œì ìœ¼ë¡œ ë‹¤ì‹œ í™œì„±í™”í•˜ëŠ” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
              exit 1
            fi

            echo "âœ… Health check successful for $NEXT environment."
            echo "ğŸ”„ Switching traffic..."

            echo "ğŸ›‘ Stopping and removing $CURRENT environment (frontend-$CURRENT)..."
            sudo docker stop "frontend-$CURRENT" || true
            sudo docker rm "frontend-$CURRENT" || true
            
            # --- ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ì˜ ë¡œì§ ìœ ì§€ ---
            # ì„±ê³µì ìœ¼ë¡œ í—¬ìŠ¤ì²´í¬ëœ $NEXT í™˜ê²½ì„ ì¤‘ì§€, ì‚­ì œ í›„ ë‹¤ì‹œ docker compose up í•˜ëŠ” ë¶€ë¶„ì…ë‹ˆë‹¤.
            # íŠ¹ì • ì´ìœ ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì›ë³¸ ë¡œì§ì„ ìœ ì§€í•©ë‹ˆë‹¤.
            # ì¼ë°˜ì ì¸ Blue/Greenì—ì„œëŠ” ì´ ë¶€ë¶„ì´ í•„ìš” ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì´ë¯¸ $NEXTëŠ” ì˜ ì‹¤í–‰ ì¤‘).
            # ëŒ€ì‹ , ì´ ì‹œì ì—ì„œ ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„¤ì •ì„ ë³€ê²½í•˜ì—¬ íŠ¸ë˜í”½ì„ $NEXTë¡œ ì „í™˜í•©ë‹ˆë‹¤.
            echo "âš ï¸ Force restarting $NEXT environment as per original script logic (stop, rm, up)..."
            sudo docker stop "frontend-$NEXT" || true
            sudo docker rm "frontend-$NEXT" || true
            sudo docker compose up -d # $NEXT í™˜ê²½ì„ ë‹¤ì‹œ ì‹œì‘
            # --- ì›ë³¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ ë ---

            echo "$NEXT" > /opt/frontend-current
            echo "ğŸ‰ Prod Blue-Green deployment to $NEXT complete. $NEXT is now active."

      - name: Set Status (Prod)
        id: set-status
        if: success()
        run: echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Set Status (Prod Failure)
        if: failure() && steps.deploy-step.outcome == 'failure' # deploy-stepì´ ì‹¤íŒ¨í–ˆì„ ë•Œë§Œ
        run: echo "status=failure" >> "$GITHUB_OUTPUT"
  
  notify:
    name: Discord Notification
    needs: [deploy-dev, deploy-prod]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord Message
        run: |
          MESSAGE=""

          # Check Dev Deploy Status
          if [ "${{ needs.deploy-dev.result }}" != "" ]; then
            STATUS_DEV="${{ needs.deploy-dev.outputs.status }}"
            if [ "$STATUS_DEV" = "success" ]; then
              MESSAGE="${MESSAGE}âœ… \`[FE develop]\` ë°°í¬ ì™„ë£Œ\n"
            elif [ "$STATUS_DEV" = "failure" ]; then
              MESSAGE="${MESSAGE}ğŸš¨ \`[FE develop]\` ë°°í¬ ì‹¤íŒ¨\n"
            fi
          fi

          # Check Prod Deploy Status
          if [ "${{ needs.deploy-prod.result }}" != "" ]; then
            STATUS_PROD="${{ needs.deploy-prod.outputs.status }}"
            if [ "$STATUS_PROD" = "success" ]; then
              MESSAGE="${MESSAGE}âœ… \`[FE prod]\` ë°°í¬ ì™„ë£Œ (Blue-Green)\n"
            elif [ "$STATUS_PROD" = "failure" ]; then
              MESSAGE="${MESSAGE}ğŸš¨ \`[FE prod]\` ë°°í¬ ì‹¤íŒ¨ (í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ë“±)\n"
            fi
          fi

          if [ -z "$MESSAGE" ]; then
            MESSAGE="âš ï¸ ë°°í¬ ìƒíƒœ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"$MESSAGE\"}" \
               ${{ secrets.DISCORD_WEBHOOK_URL }}
