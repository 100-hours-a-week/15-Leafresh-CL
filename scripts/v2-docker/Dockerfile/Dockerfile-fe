# Stage 1: Build stage
FROM node:22-alpine AS builder

WORKDIR /app

# Install pnpm globally
RUN npm install -g pnpm

# Install dependencies
COPY package.json pnpm-lock.yaml ./
RUN pnpm install --frozen-lockfile

# Copy source and build
COPY . .
RUN pnpm run build

# Stage 2: Runtime stage (minimal)
FROM node:22-alpine AS runner

WORKDIR /app

ENV NODE_ENV=production

# Create non-root user
RUN addgroup -g 1001 nodejs && adduser -u 1001 -G nodejs -s /bin/sh -D nodejs && \
    npm install -g pnpm

# --- 시간대 설정 시작 ---
# 환경 변수 TZ 설정 (대부분의 시스템 유틸리티 및 애플리케이션이 인식)
ENV TZ=Asia/Seoul

# Alpine 기반 이미지용 tzdata 패키지 설치 및 시간대 링크 설정
# 이 과정을 통해 시스템 전반에 걸쳐 시간대 정보가 올바르게 적용됩니다.
RUN apk add --no-cache tzdata && \
    cp /usr/share/zoneinfo/${TZ} /etc/localtime && \
    echo "${TZ}" > /etc/timezone
# --- 시간대 설정 끝 ---

# Copy only what is needed to run
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/public ./public
COPY --from=builder /app/package.json ./package.json
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/next.config.ts ./next.config.ts

USER nodejs

EXPOSE 3000

# ENTRYPOINT 설정 유지
ENTRYPOINT ["pnpm", "run", "test"]
